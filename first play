---
- hosts: all
  tasks:
    - name: Set the hostname
      hostname:
        name="{{ inventory_hostname }}"
      when:
        ansible_fqdn != ansible_ssh_host

    - name: update the hostname /etc/hosts file
      lineinfile:
        state=present
        dest=/etc/hosts
        line="{{ ansible_default_ipv4.address }} {{ inventory_hostname }} {{ ansible_hostname }}"
        regexp="^{{ ansible_default_ipv4.address }}"
      when:
        ansible_fqdn != ansible_ssh_host

    - name: Hostname Register
      shell: hostname | cut -b 1-2
      register: host_value
#Need to remove in prod
#    - name: Update the Name server resolv.comf
#      template:
#        src: /root/hostname-change/templates/resolv-conf.j2
#        dest: /etc/resolv.conf
#        owner: root
#        group: root
#        mode: 0644

    - name: Prevent the history file
      lineinfile:
        path: /etc/profile
        state: present
        line: "{{ item }}"
      with_items:
      - "unset HISTFILE"
      - 'export LESSHISTFILE="-"'


    - name: sshd config file updated
      lineinfile:
        line: "{{ item.line }}"
        regexp: "{{ item.regexp }}"
        path: /etc/ssh/sshd_config
        state: present
        backup: true
        validate: 'sshd -t -f %s'
      loop:
        - line: UseDNS no
          regexp: "^UseDNS"
        - line: PubkeyAuthentication yes
          regexp: "^PubkeyAuthentication"
        - line: PasswordAuthentication yes
          regexp: "^PasswordAuthentication"
        - line: ChallengeResponseAuthentication yes
          regexp: "^ChallengeResponseAuthentication"
      notify: Restart ssh

    - name: Local Infra user
      user:
        name: InfraAdmin
        password: '$6$x2kB/9Y.KoSgZXlg$YAXnb3qW7aE9NV75Wnlqhn9rT6eSBKrcptn7jKyhftNWcoudgTi5m91Z68lrAqEsjYxUZSw3Zfdib6W9WD/w20'
        shell: /bin/bash
        createhome: yes
        home: /home/InfraAdmin
        append: yes
        expires: -1
        password_expire_max: 99999
        password_expire_min: 0

    - name: Add the InfraAdmin to sudoers file
      lineinfile:
        path: /etc/sudoers
        line: "InfraAdmin ALL=(ALL) NOPASSWD: ALL"
        validate: 'visudo -cf %s'

#In Jazz we need to uncomment this
#    - name: TimeZone Set for North America and Europe
#      community.general.timezone:
#        name: >
#              {% if host_value.stdout == "NA" %}
#                    America/Los_Angeles
#              {% else %}
#                    UTC
#              {% endif %}

    - name: Default package install
      package:
        name: "{{ item }}"
        state: latest
        update_cache: yes
      with_items:
        - chrony
        - gcc
        - make

    - name: Chrony configuration
      lineinfile:
        path: /etc/chrony.conf
        line: "server 192.168.0.1 prefer iburst minpoll 4 maxpoll 4"
      notify: Restart chrony
      when: ansible_pkg_mgr != "apt"

    - name: Chrony configuration
      lineinfile:
        path: /etc/chrony/chrony.conf
        line: "server 192.168.0.1 prefer iburst minpoll 4 maxpoll 4"
      notify: Restart chrony
      when: ansible_pkg_mgr == "apt"

    - name: AD Join Package Installation on REDHAT FAMILY
      dnf:
        name: '{{ item }}'
        state: latest
      with_items:
        - [ realmd, sssd, oddjob, oddjob-mkhomedir, adcli, samba-common*, krb5-workstation ]
      when: ansible_os_family == "RedHat"
      notify:
        - Restart realmd
      tags: AD-JOIN-RHEL

    - name: AD Join Package Installation on APT FAMILY
      apt:
        name: "{{ item }}"
        state: latest
      with_items:
        - [ realmd, libnss-sss, libpam-sss, sssd, sssd-tools, adcli, samba-common-bin, oddjob, oddjob-mkhomedir, packagekit ]
      when: ansible_pkg_mgr == "apt"
      notify:
        - Restart realmd
      tags: AD-JOIN

#This need to uncomment in live
#    - name: AD Join Package Installation on SUSE
#      zypper:
#        name: "{{ item }}"
#        state: latest
#      with_items:
#        - [ krb5-client, samba-client, openldap2-client, sssd*, openldap2-client ]
#      when: ansible_os_family == "SuSE"
#      tags: AD-JOIN

#    - name: Join the RHEL box to the AD
#      shell: echo '{{domain_ad_pass}}'| realm join -U '{{domain_adu_user}}' jazzpharma.com
#      when: ansible_os_family == "RedHat"
#      tags: AD-JOIN-RHEL

#    - name: Join the APT box to the AD
#      shell: echo '{{domain_ad_pass}}'| realm join -U '{{domain_adu_user}}' jazzpharma.com
#      when: ansible_pkg_mgr == "apt"
#      tags: AD-JOIN-APT

    - name: Join the SUSE box to the AD
      shell: echo '{{domain_ad_pass}}'| net ads join -U '{{domain_adu_user}}' -S jazzpharma.com
      when: ansible_os_family == "SuSE"
      tags: AD-JOIN-SUSE

    - name: KRB.CONF file update on RHEL
      template:
        src: /root/hostname-change/templates/rhel-krb5.conf.j2
        dest: /etc/krb5.conf
        owner: root
        group: root
        mode: 0644
      when: ansible_os_family == "RedHat"
      tags: AD-JOIN-RHEL

#    - name: Adding group to the AD
#      shell: realm permit -g "{{ item }}"
#      with_items:
#        - T3-PlatformSupport-Linux@jazzpharma.com
#        - T2-Integratedsupport-Monitoring@jazzpharma.com
#      when: ansible_os_family == "RedHat" or ansible_pkg_mgr == "apt"
#      tags: AD-JOIN-RHEL, AD-JOIN-APT

    - name: AD Group add in Sudoers on RHEL and APT
      lineinfile:
        path: /etc/sudoers
        line: "{{ item }} ALL=(ALL) NOPASSWD: ALL"
        validate: 'visudo -cf %s'
      with_items:
        - '%T3-PlatformSupport-Linux@jazzpharma.com'
      notify: Restart ssh
      tags: AD-JOIN-RHEL, AD-JOIN-APT, AD-JOIN-SUSE

    - name: MKHOMEDIR file update on APT
      template:
        src: /root/hostname-change/templates/ubuntu-mkhomedir.j2
        dest: /usr/share/pam-configs/mkhomedir
        owner: root
        group: root
        mode: 0644
      notify: Restart ssh
      when: ansible_pkg_mgr == "apt"
      tags: AD-JOIN-APT

    - name: Update Conf file on SuSE boxes for adding AD
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: root
        group: root
        mode: 0644
      notify: Restart ssh
      loop:
        - { src: '/root/hostname-change/templates/suse-krb5.conf.j2', dest: '/etc/krb5.conf' }
        - { src: '/root/hostname-change/templates/suse-smb.conf.j2', dest: '/etc/samba/smb.conf' }
        - { src: '/root/hostname-change/templates/suse-sssd.conf.j2', dest: '/etc/sssd/sssd.conf'}
        - { src: '/root/hostname-change/templates/suse-nsswitch.conf.j2', dest: '/etc/nsswitch.cnf' }
      when: ansible_os_family == "SuSE"
      tags: AD-JOIN-SUSE

    - name: Upgrade all packages on RHEL/CentOS/OracleLinux
      dnf:
        name: '*'
        state: latest
        update_cache: yes
      when: ansible_os_family == "RedHat" or ansible_os_family == "CentOS" or ansible_os_family == "OracleLinux"
#this need to uncomment in prod
#    - name: Upgrade all packages on SUSE
#      zypper:
#        name: '*'
#        state: latest
#        update_cache: yes
#      when: ansible_os_family == "SuSE"

    - name: Upgrade all packages on APT
      apt:
        name: '*'
        state: latest
        update_cache: yes
      when: ansible_pkg_mgr == "apt"

  handlers:
    - name: Restart ssh
      service:
        name: "{{ item }}"
        state: restarted
        enabled: true
      with_items:
        - systemd-logind
        - sshd
        - sssd

    - name: Restart chrony
      service:
        name: chronyd
        state: restarted
        enabled: true

    - name: Restart realmd
      service:
        name: realmd
        state: restarted
        enabled: true

